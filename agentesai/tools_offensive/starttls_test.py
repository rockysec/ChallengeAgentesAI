"""
Herramienta ofensiva: Test de seguridad STARTTLS LDAP
"""

import logging
from typing import Dict, Any, List
from rich.console import Console
from rich.panel import Panel
from rich.table import Table

console = Console()
logger = logging.getLogger(__name__)

def tool_starttls_test(server: str = None, base_dn: str = None, username: str = None, password: str = None) -> Dict[str, Any]:
    """
    Prueba la seguridad STARTTLS del servidor LDAP para detectar vulnerabilidades.
    
    Esta herramienta intenta establecer una conexi√≥n TLS (-ZZ) y detecta:
    - Si el servidor falla en el handshake TLS
    - Si permite continuar en texto claro (TLS downgrade)
    - Vulnerabilidades de configuraci√≥n TLS
    - Posibles ataques de downgrade
    
    Args:
        server (str, optional): Servidor LDAP (por defecto usa configuraci√≥n del sistema)
        base_dn (str, optional): DN base (por defecto usa configuraci√≥n del sistema)
        username (str, optional): Usuario para autenticaci√≥n (opcional)
        password (str, optional): Contrase√±a para autenticaci√≥n (opcional)
        
    Returns:
        Dict[str, Any]: Resultado del test STARTTLS con an√°lisis de seguridad
        
    Raises:
        No lanza excepciones, todas las excepciones son capturadas y retornadas
        como parte del diccionario de resultado.
        
    Example:
        >>> resultado = tool_starttls_test()
        >>> if not resultado["error"]:
        ...     print(f"Vulnerabilidades: {resultado['resultado']['vulnerabilidades']}")
    """
    try:
        console.print(Panel("üî¥ Iniciando test de seguridad STARTTLS LDAP", style="red"))
        
        # Importar el conector LDAP
        from ..tools_base.ldap_connector import LDAPConnector
        
        # Crear conexi√≥n LDAP
        ldap_conn = LDAPConnector()
        
        # Test 1: Conexi√≥n normal (sin TLS)
        console.print(Panel("üîç Test 1: Conexi√≥n normal sin TLS", style="blue"))
        resultado_normal = _test_conexion_normal(ldap_conn)
        
        # Test 2: Conexi√≥n con STARTTLS (-Z)
        console.print(Panel("üîí Test 2: Conexi√≥n con STARTTLS (-Z)", style="blue"))
        resultado_starttls = _test_starttls(ldap_conn)
        
        # Test 3: Conexi√≥n forzada TLS (-ZZ)
        console.print(Panel("üîê Test 3: Conexi√≥n forzada TLS (-ZZ)", style="blue"))
        resultado_tls_forzado = _test_tls_forzado(ldap_conn)
        
        # Test 4: Test de downgrade TLS
        console.print(Panel("‚ö†Ô∏è Test 4: Test de downgrade TLS", style="yellow"))
        resultado_downgrade = _test_downgrade_tls(ldap_conn)
        
        # An√°lisis de seguridad
        analisis_seguridad = _analizar_seguridad_starttls(
            resultado_normal, resultado_starttls, resultado_tls_forzado, resultado_downgrade
        )
        
        # Resultado final
        resultado_completo = {
            "tests": {
                "conexion_normal": resultado_normal,
                "starttls": resultado_starttls,
                "tls_forzado": resultado_tls_forzado,
                "downgrade": resultado_downgrade
            },
            "analisis_seguridad": analisis_seguridad,
            "metadata": {
                "herramienta": "tool_starttls_test",
                "tipo": "test_seguridad_tls",
                "categoria": "reconocimiento_ofensivo",
                "riesgo": "medio",  # Test de seguridad TLS
                "timestamp": "ahora"  # TODO: usar datetime real
            }
        }
        
        console.print(Panel("‚úÖ Test STARTTLS completado exitosamente", style="green"))
        
        return {
            "error": False,
            "resultado": resultado_completo,
            "herramienta": "tool_starttls_test",
            "tipo": "test_seguridad_tls"
        }
        
    except Exception as e:
        logger.error(f"Error en tool_starttls_test: {e}")
        return {
            "error": True,
            "mensaje": f"Error ejecutando test STARTTLS: {str(e)}",
            "herramienta": "tool_starttls_test",
            "tipo": "error_ejecucion"
        }

def _test_conexion_normal(ldap_conn) -> Dict[str, Any]:
    """
    Test de conexi√≥n normal sin TLS.
    
    Args:
        ldap_conn: Conexi√≥n LDAP
        
    Returns:
        Dict[str, Any]: Resultado del test
    """
    try:
        # Intentar conexi√≥n normal
        if ldap_conn.connect():
            # Realizar b√∫squeda simple para verificar funcionalidad
            resultado_busqueda = ldap_conn.search("", "(objectClass=*)")
            
            return {
                "estado": "exitoso",
                "conexion": True,
                "busqueda": len(resultado_busqueda) > 0,
                "tls_activo": False,
                "vulnerabilidad": "Conexi√≥n en texto claro permitida"
            }
        else:
            return {
                "estado": "fallido",
                "conexion": False,
                "busqueda": False,
                "tls_activo": False,
                "vulnerabilidad": "No se pudo establecer conexi√≥n"
            }
            
    except Exception as e:
        return {
            "estado": "error",
            "conexion": False,
            "busqueda": False,
            "tls_activo": False,
            "vulnerabilidad": f"Error en conexi√≥n normal: {str(e)}"
        }

def _test_starttls(ldap_conn) -> Dict[str, Any]:
    """
    Test de conexi√≥n con STARTTLS (-Z).
    
    Args:
        ldap_conn: Conexi√≥n LDAP
        
    Returns:
        Dict[str, Any]: Resultado del test
    """
    try:
        # Intentar conexi√≥n con STARTTLS
        if ldap_conn.connect():
            # Simular STARTTLS (en la implementaci√≥n real se usar√≠a ldap.start_tls_s())
            # Por ahora, verificamos si la conexi√≥n est√° activa
            resultado_busqueda = ldap_conn.search("", "(objectClass=*)")
            
            return {
                "estado": "exitoso",
                "conexion": True,
                "busqueda": len(resultado_busqueda) > 0,
                "tls_activo": False,  # STARTTLS no est√° implementado en el conector actual
                "vulnerabilidad": "STARTTLS no implementado en el conector",
                "nota": "Requiere implementaci√≥n de STARTTLS en LDAPConnector"
            }
        else:
            return {
                "estado": "fallido",
                "conexion": False,
                "busqueda": False,
                "tls_activo": False,
                "vulnerabilidad": "No se pudo establecer conexi√≥n STARTTLS"
            }
            
    except Exception as e:
        return {
            "estado": "error",
            "conexion": False,
            "busqueda": False,
            "tls_activo": False,
            "vulnerabilidad": f"Error en STARTTLS: {str(e)}"
        }

def _test_tls_forzado(ldap_conn) -> Dict[str, Any]:
    """
    Test de conexi√≥n forzada TLS (-ZZ).
    
    Args:
        ldap_conn: Conexi√≥n LDAP
        
    Returns:
        Dict[str, Any]: Resultado del test
    """
    try:
        # Intentar conexi√≥n forzada TLS
        # En la implementaci√≥n real, esto forzar√≠a TLS desde el inicio
        if ldap_conn.connect():
            # Simular verificaci√≥n TLS forzado
            resultado_busqueda = ldap_conn.search("", "(objectClass=*)")
            
            return {
                "estado": "exitoso",
                "conexion": True,
                "busqueda": len(resultado_busqueda) > 0,
                "tls_activo": False,  # TLS forzado no est√° implementado en el conector actual
                "vulnerabilidad": "TLS forzado no implementado en el conector",
                "nota": "Requiere implementaci√≥n de TLS forzado en LDAPConnector"
            }
        else:
            return {
                "estado": "fallido",
                "conexion": False,
                "busqueda": False,
                "tls_activo": False,
                "vulnerabilidad": "No se pudo establecer conexi√≥n TLS forzado"
            }
            
    except Exception as e:
        return {
            "estado": "error",
            "conexion": False,
            "busqueda": False,
            "tls_activo": False,
            "vulnerabilidad": f"Error en TLS forzado: {str(e)}"
        }

def _test_downgrade_tls(ldap_conn) -> Dict[str, Any]:
    """
    Test de downgrade TLS (intentar forzar texto claro despu√©s de TLS).
    
    Args:
        ldap_conn: Conexi√≥n LDAP
        
    Returns:
        Dict[str, Any]: Resultado del test
    """
    try:
        # Simular test de downgrade
        # En la implementaci√≥n real, esto intentar√≠a forzar texto claro despu√©s de TLS
        
        if ldap_conn.connect():
            # Intentar b√∫squeda para ver si la conexi√≥n sigue funcionando
            resultado_busqueda = ldap_conn.search("", "(objectClass=*)")
            
            return {
                "estado": "simulado",
                "conexion": True,
                "busqueda": len(resultado_busqueda) > 0,
                "tls_activo": False,
                "vulnerabilidad": "Test de downgrade no implementado completamente",
                "nota": "Requiere implementaci√≥n completa de STARTTLS/TLS en LDAPConnector"
            }
        else:
            return {
                "estado": "fallido",
                "conexion": False,
                "busqueda": False,
                "tls_activo": False,
                "vulnerabilidad": "No se pudo establecer conexi√≥n para test de downgrade"
            }
            
    except Exception as e:
        return {
            "estado": "error",
            "conexion": False,
            "busqueda": False,
            "tls_activo": False,
            "vulnerabilidad": f"Error en test de downgrade: {str(e)}"
        }

def _analizar_seguridad_starttls(resultado_normal: Dict, resultado_starttls: Dict, 
                                resultado_tls_forzado: Dict, resultado_downgrade: Dict) -> Dict[str, Any]:
    """
    Analiza la seguridad de los resultados del test STARTTLS.
    
    Args:
        resultado_normal (Dict): Resultado del test de conexi√≥n normal
        resultado_starttls (Dict): Resultado del test STARTTLS
        resultado_tls_forzado (Dict): Resultado del test TLS forzado
        resultado_downgrade (Dict): Resultado del test de downgrade
        
    Returns:
        Dict[str, Any]: An√°lisis de seguridad
    """
    analisis = {
        "riesgos_detectados": [],
        "vulnerabilidades_potenciales": [],
        "recomendaciones": [],
        "nivel_riesgo": "bajo",
        "implementacion_requerida": []
    }
    
    # An√°lisis de conexi√≥n normal
    if resultado_normal.get("estado") == "exitoso" and resultado_normal.get("conexion"):
        analisis["riesgos_detectados"].append("Conexi√≥n en texto claro permitida")
        analisis["vulnerabilidades_potenciales"].append("Datos transmitidos sin cifrado")
        analisis["nivel_riesgo"] = "medio"
        analisis["recomendaciones"].append("Forzar uso de TLS para todas las conexiones")
    
    # An√°lisis de STARTTLS
    if resultado_starttls.get("estado") == "exitoso":
        if not resultado_starttls.get("tls_activo"):
            analisis["implementacion_requerida"].append("Implementar STARTTLS en LDAPConnector")
            analisis["recomendaciones"].append("Implementar soporte completo para STARTTLS")
    
    # An√°lisis de TLS forzado
    if resultado_tls_forzado.get("estado") == "exitoso":
        if not resultado_tls_forzado.get("tls_activo"):
            analisis["implementacion_requerida"].append("Implementar TLS forzado en LDAPConnector")
            analisis["recomendaciones"].append("Implementar soporte para conexiones TLS forzadas")
    
    # An√°lisis de downgrade
    if resultado_downgrade.get("estado") == "simulado":
        analisis["implementacion_requerida"].append("Implementar test completo de downgrade TLS")
        analisis["recomendaciones"].append("Implementar detecci√≥n de ataques de downgrade")
    
    # Recomendaciones generales
    if analisis["nivel_riesgo"] == "medio":
        analisis["recomendaciones"].append("Configurar servidor LDAP para requerir TLS")
        analisis["recomendaciones"].append("Implementar pol√≠ticas de seguridad TLS")
    
    if analisis["implementacion_requerida"]:
        analisis["recomendaciones"].append("Completar implementaci√≥n de funcionalidades TLS en LDAPConnector")
    
    return analisis

def mostrar_resultado_starttls(resultado: Dict[str, Any]):
    """
    Muestra el resultado del test STARTTLS de manera formateada y organizada.
    
    Args:
        resultado (Dict[str, Any]): Resultado de tool_starttls_test
    """
    if resultado.get("error"):
        console.print(Panel(f"‚ùå Error: {resultado['mensaje']}", style="red"))
        return
    
    data = resultado["resultado"]
    tests = data["tests"]
    analisis_seguridad = data["analisis_seguridad"]
    
    # T√≠tulo principal
    console.print(Panel("üîê TEST DE SEGURIDAD STARTTLS LDAP", style="bold red"))
    console.print()
    
    # Mostrar cada test individualmente con detalles
    console.print(Panel("üß™ DETALLES DE CADA PRUEBA REALIZADA", style="bold blue"))
    console.print()
    
    # Test 1: Conexi√≥n Normal
    test_normal = tests["conexion_normal"]
    console.print(Panel("üîç PRUEBA 1: Conexi√≥n Normal (sin TLS)", style="cyan"))
    console.print(f"   üìä Estado: {test_normal['estado'].upper()}")
    console.print(f"   üîå Conexi√≥n: {'‚úÖ Activa' if test_normal['conexion'] else '‚ùå Fallida'}")
    console.print(f"   üîç B√∫squeda: {'‚úÖ Exitosa' if test_normal['busqueda'] else '‚ùå Fallida'}")
    console.print(f"   üîê TLS Activo: {'‚úÖ S√≠' if test_normal['tls_activo'] else '‚ùå No'}")
    console.print(f"   ‚ö†Ô∏è Vulnerabilidad: {test_normal['vulnerabilidad']}")
    if test_normal.get('nota'):
        console.print(f"   üìù Nota: {test_normal['nota']}")
    console.print()
    
    # Test 2: STARTTLS
    test_starttls = tests["starttls"]
    console.print(Panel("üîí PRUEBA 2: Conexi√≥n STARTTLS (-Z)", style="cyan"))
    console.print(f"   üìä Estado: {test_starttls['estado'].upper()}")
    console.print(f"   üîå Conexi√≥n: {'‚úÖ Activa' if test_starttls['conexion'] else '‚ùå Fallida'}")
    console.print(f"   üîç B√∫squeda: {'‚úÖ Exitosa' if test_starttls['busqueda'] else '‚ùå Fallida'}")
    console.print(f"   üîê TLS Activo: {'‚úÖ S√≠' if test_starttls['tls_activo'] else '‚ùå No'}")
    console.print(f"   ‚ö†Ô∏è Vulnerabilidad: {test_starttls['vulnerabilidad']}")
    if test_starttls.get('nota'):
        console.print(f"   üìù Nota: {test_starttls['nota']}")
    console.print()
    
    # Test 3: TLS Forzado
    test_tls_forzado = tests["tls_forzado"]
    console.print(Panel("üîê PRUEBA 3: TLS Forzado (-ZZ)", style="cyan"))
    console.print(f"   üìä Estado: {test_tls_forzado['estado'].upper()}")
    console.print(f"   üîå Conexi√≥n: {'‚úÖ Activa' if test_tls_forzado['conexion'] else '‚ùå Fallida'}")
    console.print(f"   üîç B√∫squeda: {'‚úÖ Exitosa' if test_tls_forzado['busqueda'] else '‚ùå Fallida'}")
    console.print(f"   üîê TLS Activo: {'‚úÖ S√≠' if test_tls_forzado['tls_activo'] else '‚ùå No'}")
    console.print(f"   ‚ö†Ô∏è Vulnerabilidad: {test_tls_forzado['vulnerabilidad']}")
    if test_tls_forzado.get('nota'):
        console.print(f"   üìù Nota: {test_tls_forzado['nota']}")
    console.print()
    
    # Test 4: Downgrade TLS
    test_downgrade = tests["downgrade"]
    console.print(Panel("‚ö†Ô∏è PRUEBA 4: Test de Downgrade TLS", style="cyan"))
    console.print(f"   üìä Estado: {test_downgrade['estado'].upper()}")
    console.print(f"   üîå Conexi√≥n: {'‚úÖ Activa' if test_downgrade['conexion'] else '‚ùå Fallida'}")
    console.print(f"   üîç B√∫squeda: {'‚úÖ Exitosa' if test_downgrade['busqueda'] else '‚ùå Fallida'}")
    console.print(f"   üîê TLS Activo: {'‚úÖ S√≠' if test_downgrade['tls_activo'] else '‚ùå No'}")
    console.print(f"   ‚ö†Ô∏è Vulnerabilidad: {test_downgrade['vulnerabilidad']}")
    if test_downgrade.get('nota'):
        console.print(f"   üìù Nota: {test_downgrade['nota']}")
    console.print()
    
    # Resumen de resultados
    console.print(Panel("üìã RESUMEN DE RESULTADOS", style="bold green"))
    total_tests = len(tests)
    tests_exitosos = sum(1 for test in tests.values() if test.get('estado') == 'exitoso')
    tests_fallidos = sum(1 for test in tests.values() if test.get('estado') == 'fallido')
    tests_error = sum(1 for test in tests.values() if test.get('estado') == 'error')
    
    console.print(f"   üß™ Total de pruebas: {total_tests}")
    console.print(f"   ‚úÖ Exitosas: {tests_exitosos}")
    console.print(f"   ‚ùå Fallidas: {tests_fallidos}")
    console.print(f"   üí• Con error: {tests_error}")
    console.print()
    
    # An√°lisis de seguridad
    console.print(Panel("üîí AN√ÅLISIS DE SEGURIDAD", style="bold red"))
    console.print(f"   üö® Nivel de Riesgo: {analisis_seguridad['nivel_riesgo'].upper()}")
    console.print(f"   ‚ö†Ô∏è Riesgos Detectados: {len(analisis_seguridad['riesgos_detectados'])}")
    console.print(f"   üí• Vulnerabilidades: {len(analisis_seguridad['vulnerabilidades_potenciales'])}")
    console.print(f"   üîß Implementaciones Requeridas: {len(analisis_seguridad['implementacion_requerida'])}")
    console.print()
    
    # Riesgos detectados
    if analisis_seguridad["riesgos_detectados"]:
        console.print(Panel("üö® RIESGOS DETECTADOS", style="bold red"))
        for i, riesgo in enumerate(analisis_seguridad["riesgos_detectados"], 1):
            console.print(f"   {i}. {riesgo}")
        console.print()
    
    # Vulnerabilidades potenciales
    if analisis_seguridad["vulnerabilidades_potenciales"]:
        console.print(Panel("üí• VULNERABILIDADES POTENCIALES", style="bold red"))
        for i, vuln in enumerate(analisis_seguridad["vulnerabilidades_potenciales"], 1):
            console.print(f"   {i}. {vuln}")
        console.print()
    
    # Recomendaciones
    if analisis_seguridad["recomendaciones"]:
        console.print(Panel("üí° RECOMENDACIONES DE SEGURIDAD", style="bold yellow"))
        for i, rec in enumerate(analisis_seguridad["recomendaciones"], 1):
            console.print(f"   {i}. {rec}")
        console.print()
    
    # Implementaciones requeridas
    if analisis_seguridad["implementacion_requerida"]:
        console.print(Panel("üîß IMPLEMENTACIONES REQUERIDAS", style="bold blue"))
        for i, impl in enumerate(analisis_seguridad["implementacion_requerida"], 1):
            console.print(f"   {i}. {impl}")
        console.print()
    
    # Conclusi√≥n
    nivel_riesgo = analisis_seguridad["nivel_riesgo"]
    if nivel_riesgo == "alto":
        estilo_conclusion = "bold red"
        emoji = "üö®"
        mensaje = "ALTO RIESGO - Requiere atenci√≥n inmediata"
    elif nivel_riesgo == "medio":
        estilo_conclusion = "bold yellow"
        emoji = "‚ö†Ô∏è"
        mensaje = "RIESGO MEDIO - Requiere atenci√≥n pronto"
    else:
        estilo_conclusion = "bold green"
        emoji = "‚úÖ"
        mensaje = "RIESGO BAJO - Sistema relativamente seguro"
    
    console.print(Panel(f"{emoji} CONCLUSI√ìN: {mensaje}", style=estilo_conclusion)) 